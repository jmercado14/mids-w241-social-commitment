---
title: 'Final Study Data Analysis'
author: "April Kim, Jennifer Podracky, Saurav Datta"
output:
  pdf_document: default
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(data.table)
library(lmtest)
library(pwr)
library(lsr)
library(cobalt)
library(stringr)
library(AER)
```


##Read in data and reformat##
```{r}
assigned_treatment_seq <- data.frame(seq_id = c(1,2,3,4,5,6), 
                                     day1 = c(0,0,1,1,2,2),
                                     day2 = c(1,2,0,2,0,1),
                                     day3 = c(2,1,2,0,1,0))
d2 <- fread("241 Participant List - Final Study Results - 20181215.csv", na.strings=c("","NA"))
d2[UserId == 65,]$Q10 <- "In person"
d2[UserId == 13,]$Q6 <- "Through digital means"
# stringsAsFactors = F)
names(d2) <- str_replace_all(names(d2), c(" " = "." , "," = "" ))

# Not applicable = 0
# Through digital means = 1
# In person = 2
# Both in person and through digital means = 3

d2 <- d2[, .(userId = UserId,
             treatment_seq = as.integer(Treatment.Seq),
             day1_treatment = as.integer(as.character(factor(Q6, levels = c('Not applicable', 'In person', 
                                                                            'Through digital means'),
                                                             labels = c(0, 2, 1)))), 
             day2_treatment = as.integer(as.character(factor(Q10, levels = c('Not applicable', 'In person', 
                                                                             'Through digital means', 
                                                                             'Both in person and through digital means'),
                                                             labels = c(0, 2, 1, 3)))),
             day3_treatment = as.integer(as.character(factor(Q14, levels = c('Not applicable', 'In person', 
                                                                             'Through digital means', 
                                                                             'Both in person and through digital means'),
                                                             labels = c(0, 2, 1, 3)))),
             day1_steps = as.numeric(gsub("\\,", "", Q7)),
             day2_steps = as.numeric(gsub("\\,", "", Q11)),
             day3_steps = as.numeric(gsub("\\,", "", Q15)),
             age_range = as.integer(as.character(factor(Age, levels = c('18 - 24', 
                                                                        "25 - 34",
                                                                        "35 - 44",
                                                                        "45 - 54",
                                                                        "55 - 64",
                                                                        "65+"),
                                                        labels = c(0, 1, 2, 3, 4, 5)))),
             # gender = factor(Gender),
             gender = as.integer(as.character(factor(Gender, levels = c('Male', 'Female', 'Gender non-conforming'),
                                                     labels = c(0, 1, 2)))),
             lives_with_others = as.integer(as.character(factor(Living.Situation, levels = c('Alone', 'With others'),
                                                                labels = c(0, 1)))),
             # know_us = factor(Q17),
             know_us = as.integer(as.character(factor(Q17, levels = c('No', 'Yes'),
                                                      labels = c(0, 1)))),
             location_lat = as.double(LocationLatitude),
             location_long = as.double(LocationLongitude)
)]

d2$gender[is.na(d2$gender)] <- 2
d2$age_range[is.na(d2$age_range)] <- 6
d2$lives_with_others[is.na(d2$lives_with_others)] <- 2
d2$know_us[is.na(d2$know_us)] <- 2

head(d2, 5)

#Covariate Balance Check
bal.tab(treatment_seq ~ gender + age_range + lives_with_others + know_us + location_lat + location_long, 
        data = d2)
cov_check <- lm(treatment_seq ~ gender + age_range + lives_with_others + know_us + location_lat + location_long, 
                data = d2)
summary(cov_check)
```


##Checking for ordering/priming effect##
##Is previous day's treatment highly predictive of how many steps are taken today?##
```{r}
# n = 75
df <- d2

# remove subjects/rows who were non-compliant 
# n = 24
df <- df[rowSums(is.na(df[,c(3:8)])) != ncol(df[,c(3:8)]), ]

head(df, 5)

# day 3 steps using day 1 and 2 treatment
m1 <- lm(day3_steps ~ day1_treatment + day2_treatment, df)
summary(m1)
# ATE (standard error)
print(paste0("Estimated effect of day1 treatment: ", signif(m1$coefficients[2], 3),
" (", signif(coef(summary(m1))[2,2], 3), ")"))
print(paste0("Estimated effect of day2 treatment: ", signif(m1$coefficients[3], 3),
" (", signif(coef(summary(m1))[3,2], 3), ")"))
# include days1,2 steps as covariates to uhderstand
# subjects' step counts hange as a function of
# treatment against waht they would typically do
m2 <- lm(day3_steps ~ day1_treatment + day2_treatment + day1_steps + day2_steps, df)
summary(m2)
print(paste0("Estimated effect of day1 treatment: ", signif(m2$coefficients[2], 3),
             " (", signif(coef(summary(m2))[2,2], 3), ")"))
print(paste0("Estimated effect of day2 treatment: ", signif(m2$coefficients[3], 3),
             " (", signif(coef(summary(m2))[3,2], 3), ")"))
```
We do not see that the previous days' treatment assignments to predict the last day's step count is highgly predicitive and significant, which is super for us! 

##Condense treatment sequence to 1 treatment##
```{r}
df1 <- df[,-c(4,5,7,8)] 
df2 <- df[,-c(3,5,6,8)] 
df3 <- df[,-c(3,4,6,7)] 
names(df1)[names(df1) == "day1_treatment"] = "treatment"
names(df1)[names(df1) == "day1_steps"] = "steps"
names(df2)[names(df2) == "day2_treatment"] = "treatment"
names(df2)[names(df2) == "day2_steps"] = "steps"
names(df3)[names(df3) == "day3_treatment"] = "treatment"
names(df3)[names(df3) == "day3_steps"] = "steps"
d <- rbind(df1, df2, df3)
# combine digital and in person treatment as one
d$treatment2 <- ifelse(d$treatment == 0, 0, 1)
d$outcome <- ifelse(d$steps > 5000, 1, 0)

head(d, 5)
```

##Check covariates again after transforming and create plots (Maybe we can just check covariates here?)##
```{r}
#Covariate Balance Check
bal.tab(treatment2 ~ gender + age_range + lives_with_others + know_us + location_lat + location_long, 
        data = d)
cov_check1 <- lm(treatment_seq ~ gender + age_range + lives_with_others + know_us + location_lat + location_long, 
                data = d)
summary(cov_check1)

require(gridExtra)
d.gender <- d[, c("gender", "treatment2")]
p_gender <- ggplot(d.gender, aes(x=gender, fill = factor(treatment2))) + 
  geom_bar(stat="count", position=position_dodge()) +
  theme_minimal() + theme(legend.position="top") +
  xlab("") + ylab("") + ggtitle("Gender") +
  guides(fill = guide_legend(title = "Assignment")) +
  scale_fill_discrete(labels = c("Control", "Treatment")) +
  scale_x_continuous(breaks = c(0, 1, 2), 
                     labels = c('Male', 'Female', 'Gender non-conforming'))

d.age <- d[, c("age_range", "treatment2")]
p_age <- ggplot(d.age, aes(x=age_range, fill = factor(treatment2))) + 
  geom_bar(stat="count", position=position_dodge()) +
  theme_minimal() + theme(legend.position="none") + 
  xlab("") + ylab("") + ggtitle("Age range") +
  # guides(fill = guide_legend(title = "Assignment")) +  
  # scale_fill_discrete(labels = c("Control", "Treatment")) +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5), 
                   labels = c('18 - 24', 
                              "25 - 34",
                              "35 - 44",
                              "45 - 54",
                              "55 - 64",
                              "65+"))

d.others <- d[, c("lives_with_others", "treatment2")]
p_others <- ggplot(d.others, aes(x=lives_with_others, fill = factor(treatment2))) + 
  geom_bar(stat="count", position=position_dodge()) +
  theme_minimal() + theme(legend.position="none") +
  xlab("") + ylab("") + ggtitle("Lives with others") +
  # guides(fill = guide_legend(title = "Assignment")) +  
  # scale_fill_discrete(labels = c("Control", "Treatment")) +
  scale_x_continuous(breaks = c(0, 1), 
                     labels = c('Alone', 'With others'))

d.know_us <- d[, c("know_us", "treatment2")]
p_know_us <- ggplot(d.know_us, aes(x=know_us, fill = factor(treatment2))) + 
  geom_bar(stat="count", position=position_dodge()) +
  theme_minimal() + theme(legend.position="none") +
  xlab("") + ylab("") + ggtitle("Know us") +
  # guides(fill = guide_legend(title = "Assignment")) +  
  # scale_fill_discrete(labels = c("Control", "Treatment")) +
  scale_x_continuous(breaks = c(0, 1), 
                     labels = c('No', 'Yes'))
         
grid.arrange(p_gender, p_age, p_others, p_know_us,
             ncol = 2)
```

##T-test and power calculations##
```{r}
###  Control vs treatment (digital+in person)
t.test(d[treatment2 == 0]$outcome, d[treatment2 == 1]$outcome)
# since we fail to reject the null hypothesis, 
# let's calculate number of subjects needed for 80% power
effect_size <- cohensD(d[treatment2 == 0]$outcome, d[treatment2 == 1]$outcome)
pwr.t.test(power = 0.8, d = effect_size, sig.level = 0.05, type = "two.sample")

# if we were to look at digital and in person separately
# digital
t.test(d[treatment == 0]$outcome, d[treatment == 1]$outcome)
effect_size_digital <- cohensD(d[treatment == 0]$outcome, d[treatment == 1]$outcome)
pwr.t.test(power = 0.8, d = effect_size_digital, sig.level = 0.05, type = "two.sample")
# in person
t.test(d[treatment == 0]$outcome, d[treatment == 2]$outcome)
effect_size_person <- cohensD(d[treatment == 0]$outcome, d[treatment == 2]$outcome)
pwr.t.test(power = 0.8, d = effect_size_person, sig.level = 0.05, type = "two.sample")
```


## data manipulation for paired t test!##
```{r}
'%!in%' <- function(x,y)!('%in%'(x,y))
# limit to those who complied and
# get data frame in workable format
d_complied <- rbindlist(list(subset(df, treatment_seq == 1 & df$day1_treatment == assigned_treatment_seq[1,1]
                                    & df$day2_treatment == assigned_treatment_seq[1,2]
                                    & df$day3_treatment == assigned_treatment_seq[1,3]),
                             subset(df, treatment_seq == 2 & df$day1_treatment == assigned_treatment_seq[2,1]
                                    & df$day2_treatment == assigned_treatment_seq[2,2]
                                    & df$day3_treatment == assigned_treatment_seq[2,3]),
                             subset(df, treatment_seq == 3 & df$day1_treatment == assigned_treatment_seq[3,1]
                                    & df$day2_treatment == assigned_treatment_seq[3,2]
                                    & df$day3_treatment == assigned_treatment_seq[3,3]),
                             subset(df, treatment_seq == 4 & df$day1_treatment == assigned_treatment_seq[4,1]
                                    & df$day2_treatment == assigned_treatment_seq[4,2]
                                    & df$day3_treatment == assigned_treatment_seq[4,3]),
                             subset(df, treatment_seq == 5 & df$day1_treatment == assigned_treatment_seq[5,1]
                                    & df$day2_treatment == assigned_treatment_seq[5,2]
                                    & df$day3_treatment == assigned_treatment_seq[5,3]),
                             subset(df, treatment_seq == 6 & df$day1_treatment == assigned_treatment_seq[6,1]
                                    & df$day2_treatment == assigned_treatment_seq[6,2]
                                    & df$day3_treatment == assigned_treatment_seq[6,3])
))
d_not_complied <- subset(df, userId %!in% d_complied$userId)
d_not_complied_ok <- subset(d_not_complied, d_not_complied$day1_treatment != d_not_complied$day2_treatment & 
                              d_not_complied$day1_treatment != d_not_complied$day3_treatment &
                              d_not_complied$day2_treatment != d_not_complied$day3_treatment)

d_usable <- rbind(d_complied, d_not_complied_ok)
d <- rbindlist(list(d_usable[1:nrow(d_usable),c("day1_treatment","day1_steps")],
                    d_usable[1:nrow(d_usable),c("day2_treatment","day2_steps")],
                    d_usable[1:nrow(d_usable),c("day3_treatment","day3_steps")]))
names(d) <- c("treatment","steps")
# interpolate using median steps
d$steps[is.na(d$steps)] <- median(d[which(!is.na(d$steps))]$steps)
d$outcome <- ifelse(d$steps > 5000, 1, 0)

# CACE
ITT_lm <- lm(outcome ~ treatment, data = d)
summary(ITT_lm)$coefficients[2]

# COMMENTED LINES BELOW HAS TO BE FIXED!
# SKIP DOWN TO T TEST IN LINE 290
# combine digital and in person as one treatment as
# "Both in person and through digital means"
# d1 <- d_usable
# d1a <- subset(d1, d1$day1_treatment == 1 & d1$day2_treatment == 2)
# d1a[, treatment_total_steps := day1_steps + day2_steps]
# d1b <- subset(d1, d1$day2_treatment == 1 & d1$day3_treatment == 2)
# d1b[, treatment_total_steps := day2_steps + day3_steps]
# d1c <- subset(d1, d1$day1_treatment == 1 & d1$day3_treatment == 2)
# d1c[, treatment_total_steps := day1_steps + day2_steps]
# d1d <- subset(d1, d1$day2_treatment == 2 & d1$day3_treatment == 1)
# d1d[, treatment_total_steps := day2_steps + day3_steps]
# d1e <- subset(d1, d1$day1_treatment == 2 & d1$day3_treatment == 1)
# d1e[, treatment_total_steps := day1_steps + day2_steps]
# d1f <- subset(d1, d1$day1_treatment == 2 & d1$day2_treatment == 1)
# d1f[, treatment_total_steps := day2_steps + day3_steps]
# 
# d1_comb <- rbind(d1a, d1b, d1c, d1d, d1e, d1f)
# 
# d1 <- rbindlist(list(d1_comb[1:nrow(d1_comb),c("day1_treatment","day1_steps")],
#                      d1_comb[1:nrow(d1_comb),c("day2_treatment","day2_steps")],
#                      d1_comb[1:nrow(d1_comb),c("day3_treatment","day3_steps")]))
# names(d1) <- c("treatment","steps")
# d1[d1$treatment == 1 | d1$treatment == 2, ]$treatment <- 3
# # linear interpolation 
# # d1 <- na.approx(d1, maxgap=5)
# d1 <- data.table(d1)
# d1$steps[is.na(d1$steps)] <- median(d1[which(!is.na(d1$steps))]$steps)
# d1$outcome <- ifelse(d1$steps > 5000, 1, 0)

t.test(d[treatment == 0]$outcome, d[treatment == 1]$outcome, paired = T)
cohensD(d[treatment == 0]$outcome, d[treatment == 1]$outcome, method = "paired")

### Control vs in person 
t.test(d[treatment == 0]$outcome, d[treatment == 2]$outcome, paired = T)
cohensD(d[treatment == 0]$outcome, d[treatment == 2]$outcome, method = "paired")

### Control vs in person + digital
# t.test(d1[treatment == 0]$outcome, d1[treatment == 3]$outcome)

```





